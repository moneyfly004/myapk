# 连接功能实现说明

## ✅ 已实现的功能

### 1. 点击连接后的流程

当用户点击"开始连接"按钮后，会发生以下步骤：

1. **检查节点**：验证是否有可用的节点
2. **获取路由模式**：读取当前选择的路由模式（规则模式/全局模式）
3. **生成配置**：根据节点信息和路由模式生成 sing-box 配置 JSON
4. **启动代理服务**：调用 libcore 启动本地代理服务（监听在 127.0.0.1:7890）
5. **设置系统代理**：自动修改 Windows 系统代理设置

### 2. 系统代理自动设置

✅ **已实现**：连接时会自动设置 Windows 系统代理

- **代理地址**：`127.0.0.1:7890`
- **规则模式**：设置绕过列表（本地网络不走代理）
- **全局模式**：不设置绕过列表（所有流量都走代理）

系统代理设置通过修改 Windows 注册表实现：
- 注册表路径：`HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings`
- 设置项：
  - `ProxyEnable`：启用/禁用代理
  - `ProxyServer`：代理服务器地址
  - `ProxyOverride`：绕过列表

断开连接时会自动清除系统代理设置。

### 3. 规则模式 vs 全局模式

#### 规则模式（Rules Mode）
- **系统代理**：设置为 `127.0.0.1:7890`，但设置绕过列表
- **路由规则**：根据数据库中的路由规则决定流量走向
  - 匹配规则的流量：根据规则出站（代理/直连/阻止）
  - 不匹配规则的流量：默认走代理
- **绕过列表**：本地网络（127.*, 10.*, 172.16-31.*, 192.168.*）不走代理
- **适用场景**：需要精确控制哪些网站/应用走代理

#### 全局模式（Global Mode）
- **系统代理**：设置为 `127.0.0.1:7890`，不设置绕过列表
- **路由规则**：所有流量都走代理（忽略路由规则）
- **绕过列表**：无（所有流量都走代理）
- **适用场景**：需要所有流量都通过代理

### 4. 系统托盘菜单

✅ **已实现**：右键点击系统托盘图标会显示菜单

#### 菜单项：
1. **显示窗口** - 显示主窗口
2. **隐藏窗口** - 隐藏主窗口
3. **选择节点** - 子菜单，显示所有节点（最多 10 个）
   - 每个节点显示为复选框，当前选中的节点会被标记
   - 点击节点即可切换
4. **连接/断开** - 根据当前状态显示
   - 未连接时显示"连接"按钮
   - 已连接时显示"断开连接"按钮
5. **路由模式** - 子菜单
   - 规则模式（复选框）
   - 全局模式（复选框）
6. **退出** - 退出应用程序

#### 功能说明：
- ✅ 节点选择：点击节点即可切换，菜单会自动更新
- ✅ 快速连接：点击"连接"按钮即可使用当前选中的节点连接
- ✅ 路由模式切换：可以在托盘中直接切换规则/全局模式
- ✅ 状态同步：菜单会根据当前连接状态自动更新

## 🔧 技术实现

### 系统代理设置
- 使用 `win32` 包操作 Windows 注册表
- 使用 `InternetSetOption` API 通知系统代理设置已更改
- 支持设置代理服务器、绕过列表、启用/禁用代理

### 路由规则
- 规则模式：从数据库加载启用的路由规则
- 生成 sing-box 路由配置
- 支持域名、IP、端口等匹配规则
- 支持代理、直连、阻止三种出站动作

### 系统托盘
- 使用 `tray_manager` 包
- 动态更新菜单（根据节点列表、连接状态）
- 支持子菜单（节点选择、路由模式）
- 支持复选框（显示选中状态）

## 📋 使用流程

### 连接流程
1. 选择节点（主界面或托盘菜单）
2. 选择路由模式（规则模式/全局模式）
3. 点击"开始连接"按钮
4. 系统自动：
   - 启动本地代理服务（127.0.0.1:7890）
   - 设置系统代理
   - 根据路由模式配置绕过列表

### 断开流程
1. 点击"断开连接"按钮
2. 系统自动：
   - 清除系统代理设置
   - 停止本地代理服务

### 托盘操作
1. 右键点击系统托盘图标
2. 选择节点或路由模式
3. 点击"连接"按钮
4. 连接成功后，菜单会自动更新为"断开连接"

## ⚠️ 注意事项

1. **管理员权限**：修改系统代理可能需要管理员权限（Windows 通常不需要）
2. **防火墙**：确保防火墙允许本地代理服务（127.0.0.1:7890）
3. **其他代理软件**：如果系统已设置其他代理，可能会冲突
4. **规则模式**：需要先配置路由规则才能正常工作
5. **libcore**：需要 libcore.dll 文件才能启动代理服务

## 🎯 总结

所有连接相关功能已完整实现：
- ✅ 点击连接自动设置系统代理
- ✅ 规则模式和全局模式的区别和实现
- ✅ 系统托盘菜单（节点选择、连接按钮、路由模式切换）
- ✅ 自动清除系统代理（断开连接时）

用户体验与 Android 版本保持一致，同时针对 Windows 系统进行了优化。

